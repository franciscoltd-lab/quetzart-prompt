<ion-header class="qz-header">
  <ion-toolbar class="qz-header">
    <ion-title>Registro - Establecimiento</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">Cerrar</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="qz-bg">
    <div class="wrap">

      <!-- FOTO PERFIL -->
      <div class="qz-glass block">
        <div class="block-title">Foto de perfil (opcional)</div>

        <div class="avatar-row">
          <img class="avatar" [src]="profileImagePreview || 'assets/avatar-placeholder.png'" alt="avatar" />
          <ion-button (click)="pickProfileImage()" fill="outline">
            Elegir foto
          </ion-button>
        </div>
      </div>

      <!-- FORM -->
      <form [formGroup]="form" class="qz-glass block">
        <div class="block-title">Datos del establecimiento</div>

        <!-- EMAIL -->
        <ion-item class="qz-glass" lines="none">
          <ion-input label="Email" labelPlacement="stacked" type="email" formControlName="email">
          </ion-input>
        </ion-item>

        <!-- PASSWORD -->
        <ion-item class="qz-glass" lines="none">
          <ion-input label="Contraseña" labelPlacement="stacked" type="password" maxlength="64"
            formControlName="password">
          </ion-input>
        </ion-item>

        <!-- NOMBRE -->
        <ion-item class="item" lines="none">
          <ion-input label="Nombre" labelPlacement="stacked" formControlName="name">
          </ion-input>
        </ion-item>
        <div class="err" *ngIf="f.name.touched && f.name.invalid">
          Nombre requerido.
        </div>

        <!-- CALLE -->
        <ion-item class="item" lines="none">
          <ion-input label="Calle" labelPlacement="stacked" formControlName="street">
          </ion-input>
        </ion-item>
        <div class="err" *ngIf="f.street.touched && f.street.invalid">
          Calle requerida.
        </div>

        <!-- NÚMERO -->
        <ion-item class="item" lines="none">
          <ion-input label="Número" labelPlacement="stacked" formControlName="number">
          </ion-input>
        </ion-item>
        <div class="err" *ngIf="f.number.touched && f.number.invalid">
          Número requerido.
        </div>

        <!-- CP -->
        <!-- CP -->
        <ion-item class="item" lines="none">
          <ion-input label="CP" labelPlacement="stacked" formControlName="postalCode" inputmode="numeric"
            (ionInput)="onPostalCodeChange()">
          </ion-input>

          <!-- spinner pequeñito al lado derecho -->
          <ion-spinner *ngIf="loadingCp" name="crescent" slot="end" class="cp-spinner">
          </ion-spinner>
        </ion-item>
        <div class="err" *ngIf="f.postalCode.touched && f.postalCode.invalid">
          CP inválido (5 dígitos).
        </div>
        <div class="err" *ngIf="cpError">
          {{ cpError }}
        </div>

        <!-- BLOQUE INFERIDO POR CP -->
        <div class="mini" *ngIf="colonies.length > 0 || inferredMunicipality || inferredState">

          <div class="mini-title">
            Zona detectada
          </div>

          <!-- SELECT DE COLONIA (estilo más flat) -->
          <ion-item lines="none" class="mini-select" *ngIf="colonies.length > 0">
            <ion-item lines="none" class="mini-select" *ngIf="colonies.length > 0">
              <ion-select placeholder="Selecciona colonia" formControlName="colony" interface="popover">
                <ion-select-option *ngFor="let c of colonies" [value]="c">
                  {{ c }}
                </ion-select-option>
              </ion-select>
            </ion-item>
          </ion-item>

          <div class="mini-row" *ngIf="inferredMunicipality">
            <span class="dim">Municipio</span>
            <span>{{ inferredMunicipality }}</span>
          </div>

          <div class="mini-row" *ngIf="inferredState">
            <span class="dim">Estado</span>
            <span>{{ inferredState }}</span>
          </div>
        </div>

        <!-- CATEGORÍA -->
        <ion-item class="item" lines="none">
          <ion-input label="Categoría (restaurante, cafetería...)" labelPlacement="stacked" formControlName="category">
          </ion-input>
        </ion-item>
        <div class="err" *ngIf="f.category.touched && f.category.invalid">
          Categoría requerida.
        </div>
      </form>

      <ion-button expand="block" class="cta" [disabled]="form.invalid" (click)="submit()">
        Registrar
      </ion-button>

      <div style="height: 30px;"></div>
    </div>
  </div>
</ion-content>