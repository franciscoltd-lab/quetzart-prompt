<ion-header class="qz-header">
  <ion-toolbar class="qz-header">
    <ion-title>Establecimientos</ion-title>
    <ion-buttons slot="end">
      <ion-button (click)="dismiss()">Cerrar</ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="qz-bg">
    <div style="padding: 14px; display:grid; gap:12px;">

      <div class="qz-glass" style="padding: 12px;">
        <ion-searchbar
          class="qz-input"
          placeholder="Buscar por nombre, categoría o municipio"
          [value]="search"
          (ionInput)="onSearchChange($event)">
        </ion-searchbar>
      </div>

      <div class="qz-glass" style="padding: 12px;" *ngIf="loading">
        Cargando...
      </div>

      <div class="qz-glass" style="padding: 12px;" *ngIf="!loading && !items.length">
        No se encontraron establecimientos.
      </div>

      <div class="qz-glass" style="padding: 12px;" *ngIf="items.length">
        <div style="display:flex; justify-content:space-between; margin-bottom:8px;">
          <div style="font-weight:700;">Resultados</div>
          <div style="color: var(--qz-text-dim); font-size:12px;">{{items.length}} / {{total}}</div>
        </div>

        <div style="display:grid; gap:10px;">
          <div
            *ngFor="let e of items; trackBy: trackById"
            class="qz-glass"
            style="padding: 10px; border-radius: 16px; display:flex; gap:10px; align-items:center;"
            (click)="openEstablishment(e)">

            <img
              [src]="e.profile_image_url || 'assets/avatar-placeholder.png'"
              style="width:56px; height:56px; border-radius: 14px; object-fit:cover;" />

            <div style="flex:1; min-width:0;">
              <div style="font-weight:800; font-size:14px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                {{ e.display_name }}
              </div>

              <div style="font-size:12px; color: var(--qz-text-dim); white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                {{ e.category || '—' }} • {{ e.municipality || '—' }}
              </div>
            </div>

            <ion-icon name="chevron-forward-outline" style="opacity:.7;"></ion-icon>
          </div>
        </div>
      </div>

      <ion-infinite-scroll threshold="120px" (ionInfinite)="loadMore($event)" [disabled]="ended || loading">
        <ion-infinite-scroll-content loadingText="Cargando más..."></ion-infinite-scroll-content>
      </ion-infinite-scroll>

      <div style="height: 20px;"></div>
    </div>
  </div>
</ion-content>
