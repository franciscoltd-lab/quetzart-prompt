<ion-header class="qz-header">
  <ion-toolbar class="qz-header">
    <ion-title>Perfil</ion-title>

    <ion-buttons slot="end" *ngIf="auth.isLoggedIn()">
      <ion-button (click)="logout()">
        <ion-icon name="log-out-outline"></ion-icon>
      </ion-button>
    </ion-buttons>
  </ion-toolbar>
</ion-header>

<ion-content>
  <div class="qz-bg">
    <div class="profile-wrap">

      <!-- NO LOGEADO -->
      <ng-container *ngIf="!auth.isLoggedIn(); else loggedTemplate">
        <div class="qz-glass welcome">
          <div class="t1">Tu perfil en Quetzart</div>
          <div class="t2">Inicia sesión o crea tu cuenta para continuar.</div>

          <div class="actions">
            <ion-button expand="block" (click)="openLogin()">Iniciar sesión</ion-button>
            <ion-button expand="block" fill="outline" (click)="openAccountType()">Crear cuenta</ion-button>
          </div>
        </div>
      </ng-container>

      <!-- LOGEADO -->
      <ng-template #loggedTemplate>
        <ng-container *ngIf="(profile$ | async) as p; else noProfile">

          <div class="qz-glass header-card">
            <div class="avatar-wrap">
              <img class="avatar" [src]="p.profileImage || 'https://i.pravatar.cc/240?u=qz'" alt="avatar" />
              <ion-button size="small" class="edit-avatar" (click)="changeProfileImage(p)">
                <ion-icon name="camera-outline"></ion-icon>
              </ion-button>

            </div>

            <div class="info">
              <div class="name-row">
                <div class="name">{{ p.displayName }}</div>
                <ion-button size="small" fill="clear" (click)="editName(p)">
                  <ion-icon name="create-outline"></ion-icon>
                </ion-button>
              </div>

              <div class="meta">
                <span class="qz-pill">{{ roleLabel(p) }}</span>
                <span class="qz-pill">{{ categoryOrStyle(p) }}</span>
              </div>

              <div class="bio" *ngIf="p.role === 'artist'">
                {{ p.bio || 'Sin descripción' }}

                <ion-button expand="block" fill="outline" (click)="editCategoryOrStyle(p)">
                  Editar {{ p.role === 'artist' ? 'corriente artística' : 'categoría' }}
                </ion-button>

                <ion-button expand="block" fill="outline" *ngIf="p.role === 'artist'" (click)="editBio(p)">
                  Editar descripción
                </ion-button>

              </div>
            </div>
          </div>

          <div class="qz-glass grid-card">
            <div class="grid-head">
              <div class="grid-title">{{ p.role === 'artist' ? 'Portafolio' : 'Fotos del establecimiento' }}</div>
              <ion-button size="small" (click)="addPhotos(p)">
                <ion-icon name="add-outline"></ion-icon>
                Añadir
              </ion-button>

            </div>

            <ion-grid *ngIf="p.gallery.length">
              <ion-row>
                <ion-col size="4" *ngFor="let img of p.gallery; let i = index">
                  <div class="thumb">
                    <img [src]="img" alt="img" />
                    <ion-button class="del" size="small" fill="clear" (click)="removePhoto(p, i)">
                      <ion-icon name="close-circle"></ion-icon>
                    </ion-button>
                  </div>
                </ion-col>
              </ion-row>
            </ion-grid>

            <div class="bio" *ngIf="!p.gallery.length" style="margin-top:8px;">
              Aún no tienes imágenes. Presiona “Añadir”.
            </div>
          </div>

          <div style="height: 90px;"></div>
        </ng-container>

        <!-- CASO RARO: token pero no profile -->
        <ng-template #noProfile>
          <div class="qz-glass welcome">
            <div class="t1">Sesión activa</div>
            <div class="t2">No encontramos tu perfil guardado. Crea tu perfil para continuar.</div>

            <div class="actions">
              <ion-button expand="block" (click)="openAccountType()">Crear perfil</ion-button>
              <ion-button expand="block" fill="outline" (click)="logout()">Cerrar sesión</ion-button>
            </div>
          </div>
        </ng-template>
      </ng-template>

    </div>
  </div>
</ion-content>